---
title: "Spatial Packages in *R*"
author: "Kyle Bocinsky"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  bookdown::html_document2:
    code_folding: hide
    df_print: paged
    fig_caption: yes
    toc: true
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

# install.packages("devtools")
library(devtools)

install_cran(c("sf",
               "sp",
               "raster",
               "fasterize",
               "velox",
               "FedData",
               "mapview",
               "mapedit"))

source("https://bioconductor.org/biocLite.R")
biocLite()
biocLite("rhdf5")
# install_bioc("rhdf5")

install_github(c("mt-climate-office/mcor",
                 "mt-climate-office/thredds"))

library(tidyverse)
library(thredds)
library(magrittr)
library(mcor)
library(sf)
library(raster)
library(sp)
library(fasterize)
library(velox)
library(mapview)

# Get the Flathead Reservation boundary
flathead <- mt_tribal_land %>%
  filter(Name == "Flathead") %>%
  st_transform(4326)

```

There are ***many*** spatial packages for *R* and the numbers are growing. A good resource is the [Analysis of Spatial Data CRAN Task View](https://cran.r-project.org/web/views/Spatial.html). In fact, CRAN (the repository for *R* packages) has many such task views for various types of analyses, available at [https://cran.r-project.org/web/views/](https://cran.r-project.org/web/views/).

# Vector libraries
Vectors are objects like points, lines, and polygons.

## [**sp**](https://cran.r-project.org/web/packages/sp/index.html)

- The original Swiss army knife for importing/exporting/and manipulating vector data

## [**sf**](https://github.com/r-spatial/sf)

- *Simple Features* for *R*
- Replaces **sp** with consistent API and using tidy principles

## [**rmapshaper**](https://github.com/ateucher/rmapshaper)

- Bindings to the popular [mapshaper](https://github.com/mbloch/mapshaper/) tool for editing vector data
- Implements the [Visvalingam](https://bost.ocks.org/mike/simplify/) vector simplification method
- **Preserves topology!**

# Raster libraries
Rasters are regularly shaped grids of data.

## [**raster**](https://cran.r-project.org/web/packages/raster/index.html)

- Import/export/manipulate raster layers, stacks, and bricks

## [**fasterize**](https://github.com/ecohealthalliance/fasterize)

- rast polygon-to-raster conversion

## [**velox**](https://github.com/hunzikp/velox)

- *very* fast raster point/polygon extractions and summaries using the [Boost.Geometry](https://github.com/boostorg/geometry) library

## [**stars**](https://github.com/r-spatial/stars)

- Up-and-coming evolution of **raster** with tidy principles

# Data access (a selection)

## [**rnaturalearth**](https://github.com/ropenscilabs/rnaturalearth)

- üåç an *R* package to hold and facilitate interaction with [Natural Earth](http://www.naturalearthdata.com/) map data
  - Cultural
    - Countries (lines/polygons)
    - Sovereign states (lines/polygons)
    - Disputed areas
    - States and provinces
    - Populated places (cities, towns, etc.)
    - Railroads
    - Airports
    - Ports
    - Urban areas
    - Parks and protected lands
    - Time zones
  - Physical
    - Coastline
    - Land
    - Minor islands
    - Reefs
    - Oceans
    - River and lake centerlines
    - Lakes and reservoirs
    - Physical labels
    - Playas
    - Antarctic ice shelves
    - Glaciated areas
    - Bathymetry (SRTM+)
  - Raster (mainly for backgrounds)
    - Hillshade
    - Ocean bottom
    - Faux-colored hillshade
  
## [**FedData**](https://github.com/ropensci/FedData/)

- Functions to automate downloading geospatial data available from several federated data sources
  * The [National Elevation Dataset (NED)](http://ned.usgs.gov) digital elevation models (1 and 1/3 arc-second; USGS)
  * The [National Hydrography Dataset (NHD)](http://nhd.usgs.gov) (USGS)
  * The [Soil Survey Geographic (SSURGO) database](http://websoilsurvey.sc.egov.usda.gov/) from the National Cooperative Soil Survey (NCSS), which is led by the Natural Resources Conservation Service (NRCS) under the USDA
  * The [Global Historical Climatology Network (GHCN)](http://www.ncdc.noaa.gov/data-access/land-based-station-data/land-based-datasets/global-historical-climatology-network-ghcn), coordinated by National Climatic Data Center at NOAA
  * The [Daymet](https://daymet.ornl.gov/) gridded estimates of daily weather parameters for North America, version 3, available from the Oak Ridge National Laboratory's Distributed Active Archive Center (DAAC)
  * The [International Tree Ring Data Bank (ITRDB)](http://www.ncdc.noaa.gov/data-access/paleoclimatology-data/datasets/tree-ring), coordinated by National Climatic Data Center at NOAA
  * The [National Land Cover Database (NLCD)](https://www.mrlc.gov/) from 2011, 2006, and 2001

## [**mcor**](https://github.com/mt-climate-office/mcor)
- The core *R* package for the Montana Climate Office
- All data in the NAD 1983 HARN StatePlane Montana FIPS 2500 coordinate reference system (MT State Plane, [EPSG:102300](https://epsg.io/102300))
  - Useful data
    - Montana state boundary (Cadastral)
    - Counties (Cadastral)
    - Climate Divisions (NOAA)
    - Large-scale hillshade (500 m ‚Äî good for statewide maps)
    - Tribal land
    - HUC Watersheds (WBD)
  - Data download tools for commonly used datasets
    - [GridMet](http://www.climatologylab.org/gridmet.html) (and normals)
    - [SMAP](https://smap.jpl.nasa.gov/) soil moisture
    - [SNOTEL](https://www.wcc.nrcs.usda.gov/snow/) snow data
    - [MACAv2](https://climate.northwestknowledge.net/MACA/) climate projections
  - Convenience functions including standard web and print map templates
  - More coming every day!

## [**thredds**](https://github.com/mt-climate-office/thredds)

- Access to THREDDS Servers

# Web-mapping
## [**leaflet**](http://rstudio.github.io/leaflet/)

- Bindings to the [leaflet](http://leafletjs.com/) javascript web mapping framework

## [**mapview**](https://github.com/r-spatial/mapview)

- Very quickly and conveniently create interactive visualisations of spatial data (using **leaflet**)

```{r mapview}
# install.packages("mapview")
library(mapview)
mapview(breweries)
mapview(breweries, zcol = "village")

mapview(franconia) +
  breweries

mapview(franconia, 
        zcol = "district", 
        legend = TRUE) + 
  mapview(breweries, 
          zcol = "village") +
  trails

```

## [**mapedit**](https://github.com/r-spatial/mapedit)

- Interactive editing of spatial data in *R*

```{r mapedit}
# install.packages("mapedit")
library(mapedit)

breweries2 <- editFeatures(breweries2)

mapview(breweries2)

trails2 <- trails
mapedit(trails2)
mapview(franconia) +
  breweries

```

# Exercise: Setting up your computers
Some spatial packages require other tools to be installed on your computer in orter to 

```{r install spatial packages, eval=FALSE}
# install.packages("devtools")
llibrary(devtools)

install_cran(c("sf",
               "sp",
               "raster",
               "fasterize",
               "velox",
               "FedData",
               "mapview",
               "mapedit"))

source("https://bioconductor.org/biocLite.R")
biocLite()
biocLite("rhdf5")
# install_bioc("rhdf5")

install_github(c("mt-climate-office/mcor",
                 "mt-climate-office/thredds))
```
